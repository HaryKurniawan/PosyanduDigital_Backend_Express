generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & FAMILY DATA MODELS
// ============================================

model User {
  id                  String   @id @default(uuid())
  name                String
  email               String   @unique
  password            String
  role                Role     @default(USER)
  hasCompletedProfile Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  motherData         MotherData?
  spouseData         SpouseData?
  childrenData       ChildData[]
  registrations      PosyanduRegistration[]

  @@map("users")
}

model MotherData {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  fullName        String
  phoneNumber     String
  nik             String
  birthPlace      String
  birthDate       DateTime
  education       String
  occupation      String
  bloodType       String
  jkn             String
  facilityTK1     String

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("mother_data")
}

model SpouseData {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  fullName        String
  nik             String
  occupation      String
  phoneNumber     String

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("spouse_data")
}

model ChildData {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  fullName          String
  nik               String   @unique
  birthCertificate  String
  childOrder        Int
  bloodType         String
  birthPlace        String
  birthDate         DateTime

  // Relations
  examinations      ChildExamination[]
  registrations     PosyanduRegistration[]
  immunizations     ChildImmunization[]
  kpspScreenings    KPSPScreening[]          

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("children_data")
}

// ============================================
// POSYANDU SCHEDULE & REGISTRATION MODELS
// ============================================

model PosyanduSchedule {
  id          String   @id @default(uuid())
  scheduleDate DateTime
  location    String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  examinations      ChildExamination[]
  registrations     PosyanduRegistration[]
  immunizations     ChildImmunization[]

  @@map("posyandu_schedules")
}

model PosyanduRegistration {
  id          String   @id @default(uuid())
  scheduleId  String
  schedule    PosyanduSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  childId     String
  child       ChildData @relation(fields: [childId], references: [id], onDelete: Cascade)
  userId      String
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)

  status      RegistrationStatus @default(REGISTERED)
  registeredAt DateTime @default(now())
  notes       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([scheduleId, childId])
  @@map("posyandu_registrations")
}

// ============================================
// EXAMINATION MODEL
// ============================================

model ChildExamination {
  id                String   @id @default(uuid())
  childId           String
  child             ChildData @relation(fields: [childId], references: [id], onDelete: Cascade)
  scheduleId        String
  schedule          PosyanduSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  examinationDate   DateTime
  weight            Float
  height            Float
  headCircumference Float
  armCircumference  Float
  immunization      String?
  notes             String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("child_examinations")
}

// ============================================
// IMMUNIZATION MODELS (NEW)
// ============================================

model ImmunizationTemplate {
  id              String   @id @default(uuid())
  ageRange        String   
  ageInMonths     Int      
  description     String?
  isActive        Boolean  @default(true)

  // Relations
  vaccines        ImmunizationVaccine[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("immunization_templates")
}

model ImmunizationVaccine {
  id              String   @id @default(uuid())
  templateId      String
  template        ImmunizationTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  name            String   
  dose            String   
  description     String   
  recommendedAge  String   

  // Relations
  childImmunizations ChildImmunization[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("immunization_vaccines")
}

model ChildImmunization {
  id              String   @id @default(uuid())
  childId         String
  child           ChildData @relation(fields: [childId], references: [id], onDelete: Cascade)

  vaccineId       String
  vaccine         ImmunizationVaccine @relation(fields: [vaccineId], references: [id], onDelete: Restrict)

  scheduleId      String?
  schedule        PosyanduSchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)

  vaccinationDate DateTime
  status          VaccinationStatus @default(PENDING)
  notes           String?
  administeredBy  String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([childId, vaccineId, vaccinationDate])
  @@map("child_immunizations")
}

// ============================================
// KPSP (Kuesioner Pra Skrining Perkembangan) MODELS
// ============================================

model KPSPAgeCategory {
  id              String   @id @default(uuid())
  code            String   @unique  
  name            String   
  minAgeMonths    Int      
  maxAgeMonths    Int      
  description     String?
  isActive        Boolean  @default(true)

  // Relations
  questions       KPSPQuestion[]
  screenings      KPSPScreening[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("kpsp_age_categories")
}

model KPSPQuestion {
  id              String   @id @default(uuid())
  categoryId      String
  category        KPSPAgeCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  questionNumber  Int      
  questionText    String   
  developmentArea String   
  instruction     String?  

  // Relations
  answers         KPSPAnswer[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([categoryId, questionNumber])
  @@map("kpsp_questions")
}

model KPSPScreening {
  id              String   @id @default(uuid())
  childId         String
  child           ChildData @relation(fields: [childId], references: [id], onDelete: Cascade)
  categoryId      String
  category        KPSPAgeCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  screeningDate   DateTime @default(now())
  ageAtScreening  Int      
  totalYes        Int     
  totalNo         Int      
  result          KPSPResult
  notes           String?
  recommendedAction String?

  // Relations
  answers         KPSPAnswer[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("kpsp_screenings")
}

model KPSPAnswer {
  id              String   @id @default(uuid())
  screeningId     String
  screening       KPSPScreening @relation(fields: [screeningId], references: [id], onDelete: Cascade)
  questionId      String
  question        KPSPQuestion @relation(fields: [questionId], references: [id], onDelete: Restrict)

  answer          Boolean  

  createdAt       DateTime @default(now())

  @@unique([screeningId, questionId])
  @@map("kpsp_answers")
}

enum KPSPResult {
  SESUAI              
  MERAGUKAN           
  PENYIMPANGAN        
}

// ============================================
// ENUMS
// ============================================

enum Role {
  USER
  ADMIN
}

enum RegistrationStatus {
  REGISTERED
  ATTENDED
  CANCELLED
}

enum VaccinationStatus {
  PENDING
  COMPLETED
  MISSED
  POSTPONED
}

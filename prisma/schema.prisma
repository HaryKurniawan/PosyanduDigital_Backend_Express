generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & FAMILY DATA MODELS
// ============================================

model User {
  id                  String   @id @default(uuid())
  name                String
  email               String   @unique
  password            String
  role                Role     @default(USER)
  hasCompletedProfile Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  motherData         MotherData?
  spouseData         SpouseData?
  childrenData       ChildData[]
  registrations      PosyanduRegistration[]

  @@map("users")
}

model MotherData {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  fullName        String
  phoneNumber     String
  nik             String
  birthPlace      String
  birthDate       DateTime
  education       String
  occupation      String
  bloodType       String
  jkn             String
  facilityTK1     String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("mother_data")
}

model SpouseData {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  fullName        String
  nik             String
  occupation      String
  phoneNumber     String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("spouse_data")
}

model ChildData {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  fullName          String
  nik               String   @unique  
  birthCertificate  String
  childOrder        Int
  bloodType         String
  birthPlace        String
  birthDate         DateTime
  
  // Relations
  examinations      ChildExamination[]
  registrations     PosyanduRegistration[]
  immunizations     ChildImmunization[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("children_data")
}

// ============================================
// POSYANDU SCHEDULE & REGISTRATION MODELS
// ============================================

model PosyanduSchedule {
  id          String   @id @default(uuid())
  scheduleDate DateTime
  location    String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  examinations      ChildExamination[]
  registrations     PosyanduRegistration[]
  immunizations     ChildImmunization[]

  @@map("posyandu_schedules")
}

model PosyanduRegistration {
  id          String   @id @default(uuid())
  scheduleId  String
  schedule    PosyanduSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  childId     String
  child       ChildData @relation(fields: [childId], references: [id], onDelete: Cascade)
  userId      String
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  status      RegistrationStatus @default(REGISTERED)
  registeredAt DateTime @default(now())
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([scheduleId, childId])
  @@map("posyandu_registrations")
}

// ============================================
// EXAMINATION MODEL
// ============================================

model ChildExamination {
  id                String   @id @default(uuid())
  childId           String
  child             ChildData @relation(fields: [childId], references: [id], onDelete: Cascade)
  scheduleId        String
  schedule          PosyanduSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  
  examinationDate   DateTime
  weight            Float
  height            Float
  headCircumference Float
  armCircumference  Float
  immunization      String?
  notes             String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("child_examinations")
}

// ============================================
// IMMUNIZATION MODELS (NEW)
// ============================================

model ImmunizationTemplate {
  id              String   @id @default(uuid())
  ageRange        String   // e.g., "0-1 Bulan"
  ageInMonths     Int      // e.g., 0
  description     String?
  isActive        Boolean  @default(true)
  
  // Relations
  vaccines        ImmunizationVaccine[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("immunization_templates")
}

model ImmunizationVaccine {
  id              String   @id @default(uuid())
  templateId      String
  template        ImmunizationTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  name            String   // e.g., "HB-0 (Hepatitis B)"
  dose            String   // e.g., "0" or "1"
  description     String   // e.g., "Vaksin awal untuk Hepatitis B"
  recommendedAge  String   // e.g., "0 hari"
  
  // Relations
  childImmunizations ChildImmunization[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("immunization_vaccines")
}

model ChildImmunization {
  id              String   @id @default(uuid())
  childId         String
  child           ChildData @relation(fields: [childId], references: [id], onDelete: Cascade)
  
  vaccineId       String
  vaccine         ImmunizationVaccine @relation(fields: [vaccineId], references: [id], onDelete: Restrict)
  
  scheduleId      String?
  schedule        PosyanduSchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  
  vaccinationDate DateTime
  status          VaccinationStatus @default(PENDING)
  notes           String?
  administeredBy  String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([childId, vaccineId, vaccinationDate])
  @@map("child_immunizations")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  USER
  ADMIN
}

enum RegistrationStatus {
  REGISTERED
  ATTENDED
  CANCELLED
}

enum VaccinationStatus {
  PENDING
  COMPLETED
  MISSED
  POSTPONED
}